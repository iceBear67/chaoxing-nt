var A=Object.defineProperty;var L=(e,t,s)=>t in e?A(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var y=(e,t,s)=>(L(e,typeof t!="symbol"?t+"":t,s),s);import{s as O,M as _,C as w}from"./message-fe5b63d1.js";import{l as D,_ as k}from"./lodash-4dfbea43.js";import{H as C,d as P}from"./index-26603ea5.js";import{M as I,P as N}from"./message-4d42f580.js";import{T as E}from"./index-b0b4f58c.js";import{g as G,b as M}from"./createAttachment-a64a5f42.js";import{u as x}from"./forward-bb18e89e.js";import{i as U}from"./type-6514e97f.js";const ne=["txt","img","audio"],R=5*24*60*60*1e3;async function $(e){let t=await window.RendererHelper.getTempStore("checkMsgIds");if(t==null){const a=Date.now()-R;t=(await window.MessageDbHelper.queryChatHistory(e,a,30)??[]).map(c=>c.msgid)}const s=t.length,n=t[0];return{messageIds:t,count:s,startMessageId:n}}async function ie(e){const{isAttachChatHistory:t,groupId:s}=e,n={groupid:s,vs:1};if(t){const a=O(await $(s));D.set(n,"inviteExt",a)}return n}async function ae(e){window.RendererHelper.setTempStore("inviteMemberToGroupKey",e);const t=Date.now()-R,{total:s=0}=await window.MessageDbHelper.queryChatHistoryCount(e,t)??{};window.RendererHelper.setTempStore("chatHistoryCount",s),window.RendererHelper.setTempStore("inviteWithChatHistory",!1),window.RendererHelper.setTempStore("checkMsgIds",void 0)}async function oe(e){try{return[void 0,await e]}catch(t){return[t,void 0]}}function re(e){return e&&typeof e=="object"&&"then"in e}class B{constructor(t=1,s=null){y(this,"_count",0);y(this,"_taskList",[]);y(this,"_callbackFn");y(this,"_max",1);y(this,"_hasOfflineMsg",!1);y(this,"_time");console.debug("重新更新"),this._max=t,this._count=0,this._taskList=[],this._callbackFn=s}trigger(t,s){return new Promise((n,a)=>{!this._hasOfflineMsg&&(Array.isArray(s)||"onlineState"in s&&(s==null?void 0:s.onlineState)===0)&&(console.log("存在离线消息"),this._time=new Date().getTime(),this._hasOfflineMsg=!0);const c=this._execute(t,s,n,a);console.debug("=-------------->队列",this._count,this._max,t),this._count<this._max?c():(this._taskList.push(c),console.debug("=-------------->存在队列",this._taskList.length))})}_execute(t,s,n,a){return()=>{this._count++;let c=!0,u=setTimeout(()=>{console.error("queue-warning: 任务执行超时",`fn.name: ${t==null?void 0:t.name}`),clearTimeout(u),this._count>0&&this._count--,c=!1,this._next()},1e3*10);t(s).then(n).catch(a).finally(()=>{this._count>0&&this._count--,console.debug("=-------------->执行完后队列",this._taskList.length),clearTimeout(u),c&&this._next()})}}_next(){if(this._taskList.length>0){const t=this._taskList.shift();t&&t()}else this._hasOfflineMsg&&(console.log("开始执行回调",this._time),this._hasOfflineMsg=!1,this._time&&(console.debug("离线消息处理时间",new Date().getTime()-this._time),this._time=void 0),this._callbackFn&&this._callbackFn())}}const F=C.global.t,S=I(),W=new B,z=async(e,t=!1,s)=>{if(console.debug("new fileHandler",e,t),!e)return;let{ImSaveMsg:n,ImsendMsg:a,chatType:c,to:u}=s;n||(n=f),a||(a=h);let o;if(typeof e=="string"?o=window.RendererHelper.getBaseFileInfo(e):o=G(e),!o)return;if(t){const l=await window.MainWindowHelper.loadFolderInfo(o.path);if((l==null?void 0:l.subFolderCount)>100||(l==null?void 0:l.subFileCount)>1e3)E({content:F("message.uploadMaximum"),duration:2e3});else if((l==null?void 0:l.fileSize)==0)E({content:F("message.emptyFileCannotBeUploaded"),duration:2e3});else if((l==null?void 0:l.fileSize)>1024*1024*1024*2)E({content:F("message.theFileSizeExceedsTheUploadLimit"),duration:2e3});else{const i=await M({file:o,type:"att_cloudFolder",createFakeMsg:!0}),{msg:r}=await n({msgType:_.TEXT,content:`[${F("message.cloudFolder")}]`,ext:{attachment:i},isAtt:!0,to:u,chatType:c});try{const d=await x(o.path,!0,(g,p)=>{var b;const T=new CustomEvent("attachmentProgress",{detail:{progress:g}});(b=document.getElementById(r==null?void 0:r.id))==null||b.dispatchEvent(T),r.ext.uploadId=p,S.updateMsgValue({conversationKey:r.to,messageId:r.id,message:{ext:r.ext}})});console.log("上传文件夹",d);const m=await M({data:d.data,file:o,type:"att_cloudFolder"});r.ext.attachment=m,r.sendType="sending",a({msg:r})}catch(d){d!=null&&d.errCode&&E({content:UPLOAD_FOLDER_ERROR[d==null?void 0:d.errCode],duration:2e3}),a({msg:r,isFailed:!0})}}}else if(o.type.startsWith("image/")){let l=async()=>{const i=window.RendererHelper.getBase64Image(o.path),{msg:r}=await n({msgType:_.IMAGE,content:i,to:u,chatType:c});await a({msg:r}),l=null};W.trigger(l,{})}else if(o.type.startsWith("video/")){const l=await M({file:o,type:"att_video",createFakeMsg:!0}),{msg:i}=await n({msgType:_.TEXT,content:`[${F("message.video")}]`,ext:{attachment:l},isAtt:!0,to:u,chatType:c});try{const r=await x(o.path,!1,(m,g)=>{var T;const p=new CustomEvent("attachmentProgress",{detail:{progress:m}});(T=document.getElementById(i==null?void 0:i.id))==null||T.dispatchEvent(p),i.ext.uploadId=g,S.updateMsgValue({conversationKey:i.to,messageId:i.id,message:{ext:i.ext}})});console.log("上传视频",r);const d=await M({data:r.data,file:o,type:"att_video"});i.ext.attachment=d,i.sendType="sending",a({msg:i})}catch{a({msg:i,isFailed:!0})}}else{const l=await M({file:o,type:"att_clouddisk",createFakeMsg:!0}),{msg:i}=await n({msgType:_.TEXT,content:`[${F("message.File")}]`,ext:{attachment:l},isAtt:!0,to:u,chatType:c});try{let r=await x(o.path,!1,(m,g)=>{var T;const p=new CustomEvent("attachmentProgress",{detail:{progress:m}});(T=document.getElementById(i==null?void 0:i.id))==null||T.dispatchEvent(p),i.ext.uploadId=g,S.updateMsgValue({conversationKey:i.to,messageId:i.id,message:{ext:i.ext}})});console.log("上传附件",r);const d=await M({data:r.data,file:o,type:"att_clouddisk"});i.ext.attachment=d,i.sendType="sending",a({msg:i})}catch(r){console.error("[msgFileHandler] upload attachment error:",r),a({msg:i,isFailed:!0})}}async function f(l){const{msgType:i,content:r,ext:d,isAtt:m}=l,g={chatType:c,to:u,from:String(S.loginId)};if(i===_.TEXT&&k.assign(g,{msg:r,ext:d}),i===_.IMAGE){let p=await N().getImgFileUrl(r);k.assign(g,{file:p,url:p.url})}return S.saveMsg({msgType:i,msgOptions:g,isAtt:m})}function h(l){const i=S.getSelfUserInfoDetail;return new Promise(async(r,d)=>{let{msg:m,isFailed:g}=l;(i==null?void 0:i.unitConfigInfos.length)===0&&(g=!0,E({content:F("message.noUnitTip"),duration:2e3}),d("Unit config infos are empty"));try{await S.sendShowTypeMessage({msg:m,isFailed:g},!1),r("OK")}catch{d("Sending show type message failed")}})}},v=C.global.t,K=()=>({transferTaskMap:new Map,sendFileIds:new Set,receiveFileIds:new Set,fileSavePathMap:new Map}),le=P("fileTransfer",{state:K,actions:{updateTask(e,t){this.transferTaskMap.set(e,t)},hasTask(e){return this.transferTaskMap.has(e)},getTask(e){return this.transferTaskMap.get(e)},removeTask(e){return this.transferTaskMap.delete(e)},bindOnlineFileEvents(e){console.log("[store/file-transfer] bindOnlineFileEvents",e);const t=I(),s=String(t.loginId);window.OnlineFileHelper!==void 0?(window.OnlineFileHelper.offEvent(e,"updateStatistics"),window.OnlineFileHelper.onEvent(e,"updateStatistics",()=>{const n=window.OnlineFileHelper.getTransferStatistics(e);this.updateTask(e,n);for(const a of n.waitOtherReceiveStatistic.files)this.sendFileIds.add(a.id);for(const a of n.waitSelfReceiveStatistic.files)this.receiveFileIds.add(a.id)}),window.OnlineFileHelper.offEvent(e,"transferSuccess"),window.OnlineFileHelper.onEvent(e,"transferSuccess",n=>{if(console.debug("[bindOnlineFileEvents] receive transferSuccess event",e,O(n)),this.sendFileIds.has(n.id)){const a={chatType:w.SINGLE,from:s,to:e,ext:{onlineFileInfo:n},action:"CMD_ONLINE_FILE_TRANSFER_SUCCESS"};t.sendCMDMessage(a,!0);const c={...a,to:s,from:s};t.sendCMDMessage(c);const u=window.OnlineFileHelper.getFileLocalPath(n.id)??"",f=`-1${Date.now()}`,h={from:s,to:e,chatType:w.SINGLE,type:"txt",msg:n.name,ext:{onlineFileInfo:n,onlineFileTransferSuccess:!0,localPath:u},id:f,time:Date.now()};t.createNewMessage(h).then(()=>{t.updateSingleMessageStatus(e,f)}).catch(()=>{console.error("创建本地消息在线文件卡片失败")})}}),window.OnlineFileHelper.offEvent(e,"transferFailed"),window.OnlineFileHelper.onEvent(e,"transferFailed",n=>{if(console.log("[bindOnlineFileEvents] receive transferFailed event",e,O(n)),this.sendFileIds.has(n.id)){const a={chatType:w.SINGLE,from:s,to:String(e),ext:{onlineFileInfo:n},action:"CMD_ONLINE_FILE_TRANSFER_FAILED"};t.sendCMDMessage(a);const c={...a,to:s,from:s};t.sendCMDMessage(c);const u=Date.now(),o=window.OnlineFileHelper.getFileLocalPath(n.id)??"",{name:f="",size:h=0}=n??{};t.createNewMessage({id:`-1${u}`,type:"txt",chatType:w.SINGLE,from:s,to:String(e),ext:{onlineFileInfo:n,localPath:o,onlineFileTransferFailed:!0},time:u,msg:v("transferFile.sendFailedTipMessage",{fileName:f,fileSize:h})})}}),window.OnlineFileHelper.offEvent(e,"toOfflineSending"),window.OnlineFileHelper.onEvent(e,"toOfflineSending",async n=>{const{onlineFile:a}=window.OnlineFileHelper.getTransferFileInfo(e,n)??{};if(a===void 0){console.warn("[bindOnlineFileEvents] onlineFile is undefined",e,n);return}const{name:c="",size:u=0,localFilePath:o,isFolder:f}=a,h=Date.now(),l=D.omit(a,"subFiles"),i=e,r=String(t.loginId);await t.createNewMessage({from:r,to:i,type:"txt",time:h,id:`-1${h}`,chatType:w.SINGLE,msg:v("transferFile.toOfflineSendTipMessage",{operator:v("transferFile.you"),fileName:c,fileSize:u}),ext:{onlineFileInfo:l,onlineFileToOfflineSending:!0}}),z(o,f,{to:e,chatType:w.SINGLE}),window.OnlineFileHelper.deleteTransferFileInfo(e,n)}),window.OnlineFileHelper.offEvent(e,"close"),window.OnlineFileHelper.onEvent(e,"close",n=>{window.OnlineFileHelper.deleteTransferFileInfo(e,n),E({content:v("transferFile.senderFileExpired"),duration:2e3})})):setTimeout(()=>{this.bindOnlineFileEvents(e)},500)}}}),H=C.global.t,q=200;async function ce(e,t,s,n,a){let c={};s?c={...JSON.parse(s),showRead:t}:c={showRead:t};const u={baseUrl:"https://learn.chaoxing.com",url:"/apis/im/updatetChatGroupsInfo",getParams:{groupid:e},postParams:{desc:JSON.stringify(c)},tokenSign:!0};try{const o=await window.MainWindowHelper.genRequest(u);return U(o)?V(e,t,n,a):console.error(`设置群聊已读状态失败, [errorMsg=${o.errorMsg}][result=${o.result}]`),o}catch(o){return console.error(`设置群聊已读状态失败, [error=${O(o)}]`),o}}function V(e,t,s,n){const a=I();a.sendCMDMessage({chatType:w.GROUP,to:e,action:"CMD_GROUP_CHAT_SHOW_READ",ext:{showRead:t},from:s}),a.createNewTips({msg:n,from:s,timeStamp:new Date().getTime(),chatType:w.GROUP,to:e,ext:{showRead:t}})}function de(e,t=q){const s=Number(e);return s===-1?H("message.groupReadExceedLimit",{limit:t}):s===0?H("message.groupReadclose"):s===1?H("message.groupReadopen"):""}export{ne as A,B as Q,de as a,R as b,ce as c,q as d,ie as g,oe as h,re as i,z as m,ae as r,le as u};
